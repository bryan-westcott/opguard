name: Run all PyTest Tests
on:
  # Automatically trigger it when detected changes in repo
  # Note: only keep push action as PR build is handled by
  #       dev-pr composite action which will call this as
  #       a reusable workflow (workflow_call)
  # Allow manual trigger
  workflow_dispatch:
  # Allow call trigger
  workflow_call:
jobs:
  run-all-code-checks:
    name: Run all pytest-tests
    # TODO: this will need to be a GPU
    runs-on: ubuntu-latest
    steps:
      # ---- Common Prep -----

      # Step 1: Checkout code
      - name: Checkout to the branch
        uses: actions/checkout@v4
      # Step 2: Validate yaml
      - name: Run Yamllint yaml linter
        uses: karancode/yamllint-github-action@master
        with:
          yamllint_config_filepath: ".yamllint"
          yamllint_strict: true
      # Step 3: Setup python
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version-file: "pyproject.toml"
      # Step 4: Install UV with caching
      - name: Install UV and enable caching
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true
          cache-dependency-glob: |
            pyproject.toml
            uv.lock
      # Step 5: install packages (including dev requirements for mypy)
      # Note: using --locked will also check for out-of-date uv.lock file
      # Note: pytest is in tooling group, and tests are in test extra
      - name: Install python dev packages
        run: uv sync --dev --group tooling --extra test --locked --no-compile-bytecode
      # Run pytest
      - name: Run pytest
        run: |
          uv run pytest -q
